<!DOCTYPE html>
<html lang="en" data-theme="auto">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Cascade Expense Capture — v6.5 (Proxy)</title>

  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://cdn.jsdelivr.net/npm/zod@3.23.8/lib/index.umd.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.1.0/dist/tesseract.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/lucide@latest/dist/umd/lucide.min.js" crossorigin="anonymous"></script>

  <style>
    :root{ --coal:#0A0908; --slate:#22333B; --ivory:#EAE0D5; --sable:#C6AC8E; --earth:#5E503F;
      --bg:var(--ivory); --surface:#fff; --surface-2:rgba(255,255,255,.9); --surface-tint:rgba(255,255,255,.82);
      --ink:#111; --muted:#3b4043; --border:rgba(34,51,59,.18); --accent:var(--slate); --accent-2:var(--earth);
      --ok:#2e7d32; --warn:#c48900; --bad:#b91c1c; --ring:rgba(34,51,59,.22);
      --glass-bg:linear-gradient(180deg, rgba(255,255,255,.65), rgba(255,255,255,.45));
      --glass-bd: color-mix(in oklab, var(--border), var(--accent-2) 24%);
      --chipH:#a0d8a0; --chipR:#8ecae6; --chipAI:#ffd166;
    }
    @media (prefers-color-scheme: dark){
      html[data-theme="auto"]{ --bg:#0f1315; --surface:#171b1e; --surface-2:rgba(23,27,30,.9); --surface-tint:rgba(23,27,30,.82);
        --ink:#e9eef0; --muted:#aab3b8; --border:rgba(255,255,255,.09); --accent:#9cc6dd; --accent-2:#d7bfa2; --ring:rgba(156,198,221,.35);
        --chipH:#245b2c; --chipR:#1b3b46; --chipAI:#4d3d11;
      }
    }
    body{ margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
      background: radial-gradient(1200px 600px at 10% 0%, rgba(198,172,142,.08), transparent 60%),
                  radial-gradient(800px 800px at 100% 100%, rgba(94,80,63,.05), transparent 60%),
                  linear-gradient(180deg, var(--bg), color-mix(in oklab, var(--bg), var(--sable) 12%));
      color:var(--ink); line-height:1.55; }
    .wrap{ max-width:1200px; margin:0 auto; padding:16px }
    .topbar{ display:flex; justify-content:space-between; align-items:center; padding:12px 16px; border-bottom:1px solid var(--border);
      background:linear-gradient(180deg, color-mix(in oklab, var(--bg), #fff 12%) 92%, transparent); position:sticky; top:0; z-index:40; backdrop-filter:blur(8px) }
    .brand{ font-weight:900; color:var(--accent); display:flex; gap:8px; align-items:center }
    .tabs{ display:flex; gap:8px; padding:10px 16px; border-bottom:1px solid var(--border); overflow:auto; justify-content:center }
    .tab{ padding:9px 12px; border-radius:12px; border:1px solid transparent; cursor:pointer; background:transparent; color:var(--accent); font-weight:800; white-space:nowrap; display:inline-flex; align-items:center; gap:8px; }
    .tab[aria-selected="true"]{ background:var(--surface); color:var(--ink); border-color:var(--border) }
    .card{ background:var(--glass-bg); backdrop-filter:blur(14px); border:1px solid var(--glass-bd); border-radius:16px; box-shadow:0 20px 50px rgba(0,0,0,.15) }
    .card-h{ padding:14px 16px; border-bottom:1px solid var(--border); font-weight:900; color:var(--accent); display:flex; align-items:center; gap:8px }
    .card-b{ padding:14px 16px }
    .guide{ background:var(--glass-bg); border:1px solid var(--glass-bd); border-radius:14px; padding:12px; color:var(--muted); display:grid; gap:8px; grid-template-columns: auto 1fr; align-items:flex-start; box-shadow:0 18px 40px rgba(0,0,0,.12) }
    .btn,.btn-s{ display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border-radius:12px; border:1px solid var(--border); cursor:pointer; font-weight:700 }
    .btn{ background:var(--accent); color:#fff } .btn-s{ background:color-mix(in oklab, var(--surface), #fff 6%) }
    .input,.textarea{ width:100%; background:color-mix(in oklab, var(--surface), #fff 6%); border:1px solid var(--border); border-radius:12px; color:var(--ink); padding:10px 12px; outline:none }
    .label{ display:block; font-size:12px; color:var(--muted); margin:4px 0 6px }
    .chip{ display:inline-flex; align-items:center; gap:6px; padding:2px 8px; border:1px solid var(--border); border-radius:999px; background:#fff; font-size:12px }
    .prov{ font-weight:800 }
    .prov[data-kind="H"]{ background:var(--chipH) } .prov[data-kind="R"]{ background:var(--chipR) } .prov[data-kind="AI"]{ background:var(--chipAI) }
    .meta{ color:var(--muted); font-size:12px }
    .hidden{ display:none !important }
    .center-mobile{text-align:left} @media(max-width:768px){ .center-mobile{text-align:center} .tabs{display:none} }
    .mobile-nav{ position:fixed; bottom:0; left:0; right:0; height:65px; background:var(--surface-2); backdrop-filter:blur(10px); border-top:1px solid var(--border); display:flex; z-index:100 }
    .mobile-tab{ flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; color:var(--muted); gap:4px; border:0; background:transparent; }
    .mobile-tab[aria-selected="true"]{ color:var(--accent) }
    .fab{ position:fixed; bottom:80px; right:16px; width:60px; height:60px; border-radius:50%; background:var(--accent); color:#fff; display:flex; align-items:center; justify-content:center; border:2px solid #fff; box-shadow:0 8px 24px rgba(0,0,0,.2); cursor:pointer; z-index:101 }
  </style>
</head>
<body>
  <div class="topbar wrap">
    <div class="brand"><i data-lucide="leaf"></i> Cascade Expense Capture</div>
    <div style="display:flex; gap:8px; align-items:center">
      <button id="themeToggle" class="btn-s"><i data-lucide="sun-moon"></i> Theme</button>
      <span id="appStatus" class="meta"></span>
    </div>
  </div>

  <div class="tabs wrap center-mobile" role="tablist">
    <button class="tab" data-tab="dashboard" aria-selected="true"><i data-lucide="layout-grid"></i> Dashboard</button>
    <button class="tab" data-tab="form"><i data-lucide="file-plus-2"></i> Form</button>
    <button class="tab" data-tab="capture"><i data-lucide="camera"></i> Capture</button>
    <button class="tab" data-tab="batch"><i data-lucide="package"></i> Batch</button>
    <button class="tab" data-tab="settings"><i data-lucide="settings"></i> Settings</button>
  </div>

  <main class="wrap">
    <!-- DASHBOARD -->
    <section id="panel-dashboard">
      <div class="guide">
        <i data-lucide="info"></i>
        <div>
          <strong>Dashboard</strong>
          <ol class="meta">
            <li>KPIs update as you add items.</li>
            <li>Breakdown shows spend by category.</li>
            <li>Recent activity shows latest 6 records.</li>
          </ol>
        </div>
      </div>
      <div class="card" style="margin-top:12px"><div class="card-h"><i data-lucide="clock"></i> Recent Activity</div><div class="card-b" id="recentList"><span class="meta">No records yet.</span></div></div>
    </section>

    <!-- FORM -->
    <section id="panel-form" class="hidden">
      <div class="guide">
        <i data-lucide="file-pen-line"></i>
        <div>
          <strong>Form</strong>
          <ol class="meta">
            <li>Priority: Date, Category, Amount, Vendor, Description.</li>
            <li>Property fixed to <b>Cascade Hideaway_BRIA</b>.</li>
            <li>Add → validate & append to Sheet (proxy handles writing).</li>
          </ol>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="card-h"><i data-lucide="file-pen-line"></i> Quick Entry
          <div style="margin-left:auto; display:flex; gap:8px">
            <button id="aiSuggestBtn" class="btn-s"><i data-lucide="wand-2"></i> AI Suggest</button>
            <button id="validateBtn" class="btn-s"><i data-lucide="check-circle"></i> Validate</button>
            <button id="addToListBtn" class="btn"><i data-lucide="plus"></i> Add</button>
          </div>
        </div>
        <div class="card-b">
          <form id="expenseForm" autocomplete="off" novalidate style="display:grid; gap:12px; grid-template-columns: repeat(auto-fit, minmax(220px,1fr))">
            <input type="hidden" name="property" value="Cascade Hideaway_BRIA"/>
            <label><span class="label">Date * <span class="chip prov" id="prov-date" data-kind="" title="provenance"></span></span><input name="date" type="date" class="input" required></label>
            <label><span class="label">Vendor <span class="chip prov" id="prov-vendor" data-kind=""></span></span><input name="vendor" class="input"></label>
            <label><span class="label">Category * <span class="chip prov" id="prov-category" data-kind=""></span></span><input name="category" class="input" list="categoryList" required><datalist id="categoryList"></datalist></label>
            <label><span class="label">Amount * <span class="chip prov" id="prov-amount" data-kind=""></span></span><input name="amount" type="number" step="0.01" class="input" required></label>
            <label style="grid-column:1/-1"><span class="label">Description</span><input name="description" class="input" placeholder="Short description"></label>
            <label style="grid-column:1/-1"><span class="label">Notes</span><textarea name="notes" class="textarea"></textarea></label>
            <!-- Hidden -->
            <input type="hidden" name="attachment_drive_file_id"/><input type="hidden" name="record_drive_file_id"/><input type="hidden" name="sheet_appended_at"/>
          </form>
        </div>
      </div>
    </section>

    <!-- CAPTURE -->
    <section id="panel-capture" class="hidden">
      <div class="guide">
        <i data-lucide="camera"></i>
        <div><strong>Capture</strong>
          <ol class="meta">
            <li>Upload image/PDF → Start OCR → Smart Parse → Send to Form.</li>
            <li>Upload Attachment sends the raw file to Drive (via proxy).</li>
          </ol>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="card-h"><i data-lucide="inbox"></i> Ingest</div>
        <div class="card-b">
          <input id="fileInput" type="file" accept=".pdf,image/*" multiple class="input"/>
          <div id="ingestPreview" class="meta" style="margin-top:8px">Drop files or use the picker.</div>
        </div>
      </div>
    </section>

    <!-- BATCH -->
    <section id="panel-batch" class="hidden">
      <div class="card"><div class="card-h"><i data-lucide="package"></i> Batch</div><div class="card-b"><div id="previewTable" class="meta">No items yet.</div></div></div>
    </section>

    <!-- SETTINGS -->
    <section id="panel-settings" class="hidden">
      <div class="guide">
        <i data-lucide="settings-2"></i>
        <div>
          <strong>Settings</strong>
          <ol class="meta">
            <li><b>Proxy mode</b> ON by default — paste your Apps Script Web App URL.</li>
            <li>Spreadsheet ID & (optional) Drive folder ID.</li>
            <li>Run <b>Setup Sheet</b>. Use <b>Diagnostics</b> to verify.</li>
          </ol>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="card-h"><i data-lucide="settings"></i> Settings</div>
        <div class="card-b" style="display:grid; gap:12px; grid-template-columns: repeat(auto-fit, minmax(220px,1fr))">
          <label style="display:flex;gap:8px;align-items:center;justify-content:center"><input id="toggleProxy" type="checkbox" checked> <span>Use Proxy Web App (Apps Script)</span></label>
          <label><span class="label">Proxy URL</span><input id="proxyUrl" class="input" placeholder="https://script.google.com/macros/s/AKfycb.../exec"></label>
          <label><span class="label">Spreadsheet ID</span><input id="sheetId" class="input" placeholder="1y46k3G..."></label>
          <label><span class="label">Sheet Name</span><input id="sheetName" class="input" value="Sheet1"></label>
          <label><span class="label">Drive Folder ID (optional)</span><input id="driveFolderId" class="input" placeholder="1ABCDEF..."></label>
          <div style="display:flex; gap:8px; flex-wrap:wrap; grid-column:1/-1; justify-content:center">
            <button id="saveSettings" class="btn"><i data-lucide="save"></i> Save</button>
            <button id="setupSheet" class="btn-s"><i data-lucide="table-properties"></i> Setup Sheet</button>
            <button id="runDiagnostics" class="btn-s"><i data-lucide="stethoscope"></i> Run Diagnostics</button>
            <button id="pingProxy" class="btn-s"><i data-lucide="link-2"></i> Ping Proxy</button>
          </div>
          <div id="diagOutput" class="meta" style="grid-column:1/-1; border:1px dashed var(--border); padding:10px; border-radius:12px"></div>
        </div>
      </div>
    </section>
  </main>

  <nav class="mobile-nav">
    <button class="mobile-tab" data-tab="dashboard" aria-selected="true"><i data-lucide="layout-grid"></i><span>Dashboard</span></button>
    <button class="mobile-tab" data-tab="capture"><i data-lucide="camera"></i><span>Capture</span></button>
    <button class="mobile-tab" data-tab="batch"><i data-lucide="package"></i><span>Batch</span></button>
    <button class="mobile-tab" data-tab="settings"><i data-lucide="settings"></i><span>Settings</span></button>
  </nav>
  <button class="fab" id="fab-add"><i data-lucide="plus"></i></button>

  <script>
  ;(async()=>{ 'use strict'; // async IIFE prevents "await is only valid..." parsing errors

    const $ = (s,root=document)=>root.querySelector(s);
    const $$ = (s,root=document)=>Array.from(root.querySelectorAll(s));
    const toast = (m)=>{ const s=$("#appStatus"); if(!s) return; s.textContent=m; setTimeout(()=>s.textContent="",2400); };
    const storage = { get(k,f){ try{return JSON.parse(localStorage.getItem(k))??f}catch{return f} }, set(k,v){ try{localStorage.setItem(k,JSON.stringify(v))}catch{} } };
    const CATEGORY_TAXONOMY = ["Utilities","Subscriptions","Services","Maintenance","Repairs","Supplies","Cleaning","Internet","Electricity","Water","Gas","Waste","Landscaping","Security","Insurance","Taxes","Fees","Professional Services","Software","Travel","Meals","Office","Shipping","Medical","Equipment","Other"];
    let records = storage.get("cx:records", []);
    let settings = storage.get("cx:settings", { useProxy:true, proxyUrl:"", spreadsheetId:"", sheetName:"Sheet1", folderId:"" });
    function applyTheme(){ if (window.lucide) window.lucide.createIcons(); } applyTheme();

    // Tabs
    function switchTab(id){ $$(".tab, .mobile-tab").forEach(b=>b.setAttribute("aria-selected", String(b.dataset.tab===id))); ["dashboard","form","capture","batch","settings"].forEach(t=>$("#panel-"+t)?.classList.toggle("hidden", t!==id)); }
    $$(".tab, .mobile-tab").forEach(b=>b.addEventListener("click",()=>switchTab(b.dataset.tab))); switchTab("capture");
    $("#fab-add")?.addEventListener("click",()=>switchTab("form"));

    // Category datalist
    const dl=$("#categoryList"); if(dl) dl.innerHTML = CATEGORY_TAXONOMY.map(c=>`<option value="${c}"></option>`).join("");

    // Provenance helpers
    const provForm = { date:"", vendor:"", category:"", amount:"" };
    function setProv(field, kind){ provForm[field]=kind||""; const chip=$("#prov-"+field); if(chip){ chip.dataset.kind = kind||""; chip.textContent = kind||""; chip.title = kind? ({"H":"Heuristic","R":"Rule","AI":"AI"}[kind]||kind) : ""; chip.style.display = kind? "inline-flex":"none"; } }
    setProv("date",""); setProv("vendor",""); setProv("category",""); setProv("amount","");

    // Proxy client
    async function callProxy(action, payload={}){
      const url = (settings.proxyUrl||"").trim();
      if(!url) throw new Error("Proxy URL not set in Settings");
      const resp = await fetch(url, { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify({ action, sheetId:(settings.spreadsheetId||"").trim(), sheetName:(settings.sheetName||"Sheet1").trim()||"Sheet1", folderId:(settings.folderId||"").trim(), taxonomy:CATEGORY_TAXONOMY, payload }) });
      const text = await resp.text(); let data={};
      try{ data=JSON.parse(text) }catch{ data={ ok:false, status:resp.status, text } }
      if(!resp.ok || data.ok===false) throw new Error(data?.message||data?.error||text||("HTTP "+resp.status));
      return data;
    }

    async function setupSheet(){ try{ await callProxy("setupSheet",{}); toast("Sheet setup ✓"); }catch(e){ toast("Setup failed: "+e.message); } }
    $("#setupSheet")?.addEventListener("click", setupSheet);

    // Settings hydrate / save
    function hydrate(){ $("#toggleProxy").checked = settings.useProxy!==false; $("#proxyUrl").value=settings.proxyUrl||""; $("#sheetId").value=settings.spreadsheetId||""; $("#sheetName").value=settings.sheetName||"Sheet1"; $("#driveFolderId").value=settings.folderId||""; }
    hydrate();
    $("#saveSettings")?.addEventListener("click", ()=>{ settings.useProxy=$("#toggleProxy").checked; settings.proxyUrl=$("#proxyUrl").value.trim(); settings.spreadsheetId=$("#sheetId").value.trim(); settings.sheetName=$("#sheetName").value.trim()||"Sheet1"; settings.folderId=$("#driveFolderId").value.trim(); storage.set("cx:settings", settings); toast("Saved ✓"); });

    // Diagnostics
    $("#runDiagnostics")?.addEventListener("click", async()=>{
      const out=[]; const OK=(b,m)=>out.push(`<div style="display:flex;gap:8px;align-items:center"><i data-lucide="${b?"check-circle":"x-circle"}"></i><span>${m}</span></div>`);
      if(!settings.proxyUrl?.trim()) OK(false,"Proxy URL missing"); else{
        try{ await callProxy("ping",{}); OK(true,"Proxy reachable"); }catch(e){ OK(false,"Proxy ping failed: "+e.message); }
      }
      if(!settings.spreadsheetId?.trim()) OK(false,"Spreadsheet ID missing"); else OK(true,"Spreadsheet ID set");
      $("#diagOutput").innerHTML = out.join("");
      applyTheme();
    });
    $("#pingProxy")?.addEventListener("click", async()=>{ try{ await callProxy("ping",{}); toast("Proxy OK"); }catch(e){ toast("Proxy failed: "+e.message) } });

    // Form helpers
    const form=$("#expenseForm");
    function formToRec(){ const fd=new FormData(form); const r=Object.fromEntries(fd.entries()); r.amount=Number(r.amount||0); r.property="Cascade Hideaway_BRIA"; return r; }
    function fillForm(r, prov){ for(const [k,v] of Object.entries(r)){ const el=form.elements.namedItem(k); if(el) el.value=v??""; } if(prov){ for(const [f,k] of Object.entries(prov)) setProv(f,k); } }

    // AI Suggest placeholder (uses heuristics+routing via proxy only for categorization if needed)
    async function smartSuggest(seed){ // returns {fields, prov}
      const prov={}; const out={ ...seed };
      // Heuristics
      const H = heuristicExtract(seed.description || seed.vendor || "");
      Object.assign(out, H); Object.entries(H).forEach(([k,v])=>{ if(v) prov[k]="H"; });
      // Rules (simple keyword list)
      const r = applyRules(out);
      Object.entries(r.changed||{}).forEach(([k,v])=>{ out[k]=v; prov[k]="R"; });
      // AI categorization (optional, via proxy - reuse taxonomy prompt in Apps Script if you like)
      try{
        const ai = await callProxy("aiCategorize", { record: out }); // optional endpoint; if not implemented just ignore
        if(ai?.category){ out.category = ai.category; prov.category = prov.category || "AI"; }
      }catch{ /* ignore if not implemented */ }
      return { fields: out, prov };
    }

    function applyRules(rec){
      const text=[rec.vendor||"",rec.description||""].join(" ").toLowerCase();
      const rules=[ // simple built-ins; extend via Apps Script if needed
        {p:/electric|kwh|meralco|power|energy/i, cat:"Electricity"},
        {p:/water|maynilad|manila water/i, cat:"Water"},
        {p:/internet|wifi|fiber|converge|pldt/i, cat:"Internet"},
        {p:/subscription|saas|netflix|spotify|adobe/i, cat:"Subscriptions"},
      ];
      const changed={};
      for(const r of rules){ if(r.p.test(text) && !rec.category){ changed.category=r.cat; break; } }
      return { changed };
    }

    function heuristicExtract(t){
      t=(t||"").replace(/\s+/g," ").trim();
      const amount = (()=>{ const pri=t.match(/Total[:\s]+(?:PHP|₱)?\s?([\d,]+(?:\.\d{2})?)/i); if(pri) return Number(pri[1].replace(/,/g,"")); const any=t.match(/(?:PHP|₱)\s?([\d,]+(?:\.\d{2})?)/i)||t.match(/\b([\d,]{3,}(?:\.\d{2})?)\b/); return any?Number(any[1].replace(/,/g,"")):0; })();
      const date = (()=>{ const iso=t.match(/\b(20\d{2}[-/]\d{1,2}[-/]\d{1,2})\b/); if(iso){ const n=iso[1].replace(/[./]/g,"-"); const p=n.split("-").map(x=>x.padStart(2,"0")); return p[0].length===4?`${p[0]}-${p[1]}-${p[2]}`:`${p[2]}-${p[0]}-${p[1]}`; } const m="january|february|march|april|may|june|july|august|september|october|november|december".split("|"); const pat=new RegExp(`\\b(${m.join("|")})\\s+(\\d{1,2}),?\\s*(\\d{4})\\b`,"i"); const r=t.match(pat); if(r){ const mm=("0"+(m.indexOf(r[1].toLowerCase())+1)).slice(-2); const dd=("0"+r[2]).slice(-2); return `${r[3]}-${mm}-${dd}` } return new Date().toISOString().slice(0,10); })();
      const vendor = (()=>{ const s=t.replace(/https?:\/\/\S+/g," ").trim(); const line=s.split(/[|·•\-–—]\s*/)[0]; const m=line.match(/[A-Z][A-Za-z0-9 &'().-]{3,}/); return m?m[0].slice(0,48).trim():""; })();
      const category = (()=>{ const map=[[/(electric|kwh|power|energy|electricity)/i,"Electricity"],[/water|maynilad|manila water/i,"Water"],[/internet|wifi|fiber|converge|pldt/i,"Internet"],[/subscription|saas|netflix|spotify|adobe/i,"Subscriptions"]]; for(const [re,cat] of map){ if(re.test(t)) return cat; } return ""; })();
      return { amount, date, vendor, category };
    }

    // Capture
    $("#fileInput")?.addEventListener("change", (e)=>{ handleFiles(e.target.files); e.target.value=""; });
    document.addEventListener("dragover", (e)=>e.preventDefault());
    document.addEventListener("drop", (e)=>{ e.preventDefault(); if(e.dataTransfer?.files?.length) handleFiles(e.dataTransfer.files); });

    async function handleFiles(files){
      const list = $("#ingestPreview"); if(list.textContent?.includes("Drop")) list.innerHTML="";
      for(const f of Array.from(files)){
        const id=Math.random().toString(36).slice(2);
        const isImg=f.type.startsWith("image/"); const isPdf=/\.pdf$/i.test(f.name) || f.type==="application/pdf";
        const card=document.createElement("div"); card.className="card"; card.style.marginTop="10px";
        card.innerHTML = `
          <div class="card-b">
            <div style="display:flex;justify-content:space-between;align-items:center"><div style="font-weight:800;display:flex;gap:8px;align-items:center"><i data-lucide="${isImg?'image':'file'}"></i> ${f.name}</div><span class="meta">${isImg?'image':'pdf'}</span></div>
            <div class="bar" style="height:8px;background:#eee;border:1px solid var(--border);border-radius:999px;overflow:hidden;margin-top:8px"><span id="bar-${id}" style="display:block;height:100%;background:linear-gradient(90deg,var(--accent),var(--accent-2));width:0%"></span></div>
            <div id="txt-${id}" class="meta" style="margin-top:8px; max-height:120px; overflow:auto">Ready. Press Start OCR.</div>
            <div id="chips-${id}" class="meta" style="display:flex; gap:6px; margin-top:6px;"></div>
            <div id="edit-${id}" class="hidden" style="margin-top:8px; display:grid; gap:8px; grid-template-columns: repeat(auto-fit, minmax(180px,1fr));">
              <label><span class="label">Date <span class="chip prov" data-p="date"></span></span><input class="input" data-f="date"></label>
              <label><span class="label">Vendor <span class="chip prov" data-p="vendor"></span></span><input class="input" data-f="vendor"></label>
              <label><span class="label">Category <span class="chip prov" data-p="category"></span></span><input class="input" data-f="category" list="categoryList"></label>
              <label><span class="label">Amount <span class="chip prov" data-p="amount"></span></span><input class="input" data-f="amount" type="number" step="0.01"></label>
              <label style="grid-column:1/-1"><span class="label">Description</span><input class="input" data-f="description"></label>
              <div style="grid-column:1/-1; display:flex; gap:8px; flex-wrap:wrap">
                <button id="ai-${id}" class="btn-s"><i data-lucide="wand-2"></i> Smart Parse</button>
                <button id="send-${id}" class="btn-s"><i data-lucide="file-pen-line"></i> Send to Form</button>
              </div>
            </div>
            <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
              <button id="start-${id}" class="btn-s"><i data-lucide="scan-text"></i> Start OCR</button>
              <button id="attach-${id}" class="btn-s"><i data-lucide="paperclip"></i> Upload Attachment</button>
            </div>
          </div>`;
        list.appendChild(card); if(window.lucide) window.lucide.createIcons({ nodes: [card] });
        const bar=$("#bar-"+id), textEl=$("#txt-"+id), chips=$("#chips-"+id), edit=$("#edit-"+id);
        const prov={date:"",vendor:"",category:"",amount:""};
        function setProvLocal(field, kind){ prov[field]=kind; const chip=edit.querySelector(`.prov[data-p="${field}"]`); if(chip){ chip.dataset.kind=kind; chip.textContent=kind; chip.title={"H":"Heuristic","R":"Rule","AI":"AI"}[kind]||kind; chip.style.display=kind?"inline-flex":"none"; } }

        $("#attach-"+id)?.addEventListener("click", async()=>{
          try{ const base64 = await fileToBase64(f); const res = await callProxy("uploadAttachment", { name:f.name, mime:f.type||"application/octet-stream", base64 }); form.elements.namedItem("attachment_drive_file_id").value = res.fileId; toast("Attachment uploaded ✓"); }catch(e){ toast("Attach failed: "+e.message); }
        });

        $("#start-"+id)?.addEventListener("click", async()=>{
          try{
            if (typeof Tesseract === 'undefined') throw new Error("Tesseract not loaded");
            textEl.textContent="Recognizing…";
            let text="", confidence=0;
            if(isImg){
              const r = await Tesseract.recognize(f,"eng",{logger:(m)=>{ if(m.status==="recognizing text"){ bar.style.width=((m.progress||0)*100).toFixed(0)+"%"; } }});
              text=(r?.data?.text||"").trim(); confidence=(r?.data?.confidence||0);
            }else{
              if(typeof pdfjsLib === "undefined") throw new Error("PDF.js not loaded");
              const buf = await f.arrayBuffer(); pdfjsLib.GlobalWorkerOptions.workerSrc="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js";
              const pdf = await pdfjsLib.getDocument({data:buf}).promise; const pieces=[]; const confs=[];
              for(let p=1;p<=Math.min(pdf.numPages,3);p++){ const page=await pdf.getPage(p); const vp=page.getViewport({scale:2}); const c=document.createElement("canvas"); const ctx=c.getContext("2d"); c.width=vp.width; c.height=vp.height; await page.render({canvasContext:ctx,viewport:vp}).promise; const r=await Tesseract.recognize(c,"eng",{logger:(m)=>{ if(m.status==="recognizing text"){ const pr=((p-1)+(m.progress||0))/Math.min(pdf.numPages,3); bar.style.width=(pr*100).toFixed(0)+"%"; } }}); pieces.push((r?.data?.text||"").trim()); confs.push(r?.data?.confidence||0); }
              text=pieces.join("\n\n"); confidence=Math.round(confs.reduce((a,b)=>a+b,0)/confs.length);
            }
            textEl.textContent = text ? (text.length>800?text.slice(0,800)+"…":text) : "(no text)";
            chips.innerHTML = `<span class="chip">Lang: ENG</span><span class="chip">Confidence: ${Math.round(confidence)}%</span><span class="chip">Size: ${(f.size/1024).toFixed(1)} KB</span>`;
            const heur = heuristicExtract(text); ["date","vendor","category","amount"].forEach(k=>setProvLocal(k, heur[k] ? "H": ""));
            edit.classList.remove("hidden");
            edit.querySelector('[data-f="date"]').value = heur.date||"";
            edit.querySelector('[data-f="vendor"]').value = heur.vendor||"";
            edit.querySelector('[data-f="category"]').value = heur.category||"";
            edit.querySelector('[data-f="amount"]').value = heur.amount||"";
            edit.querySelector('[data-f="description"]').value = text.slice(0,180);
          }catch(e){ textEl.textContent="OCR failed: "+e.message; }
        });

        $("#ai-"+id)?.addEventListener("click", async()=>{
          try{
            const seed = { description: edit.querySelector('[data-f="description"]').value, vendor: edit.querySelector('[data-f="vendor"]').value };
            const { fields, prov: pv } = await smartSuggest(seed);
            ["date","vendor","category","amount"].forEach(k=>{ if(fields[k]){ edit.querySelector(`[data-f="${k}"]`).value = fields[k]; if(pv[k]) setProvLocal(k, pv[k]); }});
            toast("Smart Parse ✓");
          }catch(e){ toast("Smart Parse failed: "+e.message); }
        });

        $("#send-"+id)?.addEventListener("click", ()=>{
          const r={ date:edit.querySelector('[data-f="date"]').value, vendor:edit.querySelector('[data-f="vendor"]').value, category:edit.querySelector('[data-f="category"]').value, amount:Number(edit.querySelector('[data-f="amount"]').value||0), description:edit.querySelector('[data-f="description"]').value };
          fillForm(r, prov); switchTab("form"); toast("Loaded into form");
        });
      }
    }
    function fileToBase64(file){ return new Promise((res,rej)=>{ const fr=new FileReader(); fr.onerror=()=>rej(new Error("read failed")); fr.onload=()=>res(btoa(String.fromCharCode(...new Uint8Array(fr.result)))); fr.readAsArrayBuffer(file); }); }

    // Add
    $("#validateBtn")?.addEventListener("click", ()=>{ const r=formToRec(); if(!r.date||!r.category||!(r.amount>0)) toast("Fix required fields"); else toast("Valid ✓"); });
    $("#aiSuggestBtn")?.addEventListener("click", async()=>{ const seed=formToRec(); const {fields,prov}=await smartSuggest(seed); fillForm(fields,prov); toast("AI suggestions applied"); });
    $("#addToListBtn")?.addEventListener("click", async()=>{
      const rec=formToRec(); if(!rec.date||!rec.category||!(rec.amount>0)){ toast("Fill required fields"); return; }
      records.push(rec); storage.set("cx:records",records); toast("Added ✓");
      try{ await callProxy("appendRecord", { rec }); form.elements.namedItem("sheet_appended_at").value = new Date().toISOString(); toast("Appended to Sheet ✓"); }catch(e){ toast("Append failed (proxy): "+e.message); }
      // reset
      ["vendor","description","notes"].forEach(n=>form.elements.namedItem(n).value=""); form.elements.namedItem("amount").value=""; setProv("date",""); setProv("vendor",""); setProv("category",""); setProv("amount","");
    });

    // Dashboard recent
    function renderRecent(){ const el=$("#recentList"); if(!records.length){ el.innerHTML='<span class="meta">No records yet.</span>'; return; } el.innerHTML = records.slice(-6).reverse().map(r=>`<div style="padding:8px 0;border-bottom:1px solid var(--border)"><div style="display:flex;justify-content:space-between"><div>${(r.vendor||r.description||"Item")}</div><div class="meta">${r.date||""}</div></div><div class="meta">${r.category||"Uncategorized"} · ₱${Number(r.amount||0).toFixed(2)}</div></div>`).join(""); }
    renderRecent();
    $("#themeToggle")?.addEventListener("click", ()=>{ const m=document.documentElement.getAttribute("data-theme")||"auto"; const order=["auto","light","dark"]; const next=order[(order.indexOf(m)+1)%order.length]; document.documentElement.setAttribute("data-theme",next); toast("Theme: "+next); });

    if(window.lucide) window.lucide.createIcons();
  })();
  </script>
</body>
</html>
